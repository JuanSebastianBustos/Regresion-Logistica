{% extends "base.html" %}

{% block title %}
Caso Práctico: Árbol de Decisión
{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="text-center mb-5">
        <h1><i class="fas fa-sitemap me-2"></i>Caso Práctico: Árbol de Decisión</h1>
        <p class="lead text-muted">Clasificación de Solicitudes de Beca Estudiantil</p>
    </div>

    <div class="row mb-5">
        <div class="col-lg-5 mb-4 mb-lg-0">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4><i class="fas fa-database me-2"></i>Dataset de Solicitudes</h4>
                </div>
                <div class="card-body">
                    <p>Este dataset contiene información sobre aplicantes a becas. El objetivo es predecir la
                        elegibilidad.</p>
                    <h5 class="mt-4">Variables del Dataset (en español)</h5>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item"><strong>Promedio Académico:</strong> Nota promedio del estudiante
                            (ej: 4.5).</li>
                        <li class="list-group-item"><strong>Ingresos Familiares:</strong> Ingreso mensual del hogar (ej:
                            1200000).</li>
                        <li class="list-group-item"><strong>Personas en el Hogar:</strong> Número de personas que viven
                            en la casa.</li>
                        <li class="list-group-item"><strong>Tipo de Institución:</strong> Si la institución de origen es
                            Pública o Privada (variable categórica).</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-lg-7">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-success text-white">
                    <h4><i class="fas fa-magic me-2"></i>Realizar una Predicción</h4>
                </div>
                <form method="POST" action="{{ url_for('dt_practico') }}" class="card-body">
                    <div class="mb-3">
                        <label for="promedio_academico" class="form-label"><strong>Promedio Académico</strong> (3.0 -
                            5.0)</label>
                        <input type="number" step="0.1" class="form-control" id="promedio_academico"
                            name="promedio_academico" value="{{ form_data.promedio if form_data }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="ingresos_familiares" class="form-label"><strong>Ingresos Familiares</strong> (ej:
                            1500000)</label>
                        <input type="number" class="form-control" id="ingresos_familiares" name="ingresos_familiares"
                            value="{{ form_data.ingresos if form_data }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="numero_personas_hogar" class="form-label"><strong>Número de Personas en el
                                Hogar</strong></label>
                        <input type="number" class="form-control" id="numero_personas_hogar"
                            name="numero_personas_hogar" value="{{ form_data.personas if form_data }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><strong>Tipo de Institución</strong></label>
                        <select class="form-select" name="tipo_institucion" required>
                            <option value="0" {% if form_data and form_data.tipo_inst==0 %}selected{% endif %}>Pública
                            </option>
                            <option value="1" {% if form_data and form_data.tipo_inst==1 %}selected{% endif %}>Privada
                            </option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-success w-100">Predecir Elegibilidad</button>
                </form>
                {% if prediction %}
                <div class="card-footer text-center">
                    <h5 class="mb-1">Resultado de la Predicción:</h5>
                    <p
                        class="display-6 {% if prediction.label == 'Aprobado' %}text-success{% else %}text-danger{% endif %}">
                        {{ prediction.label }}
                    </p>
                    <p class="text-muted">Probabilidad: {{ prediction.probability }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="text-center mb-4">
        <h2><i class="fas fa-chart-line me-2"></i>Métricas de Evaluación del Modelo</h2>
    </div>
    <div class="row">
        <div class="col-lg-4 mb-4">
            <div class="card text-center h-100 shadow-sm">
                <div class="card-header">
                    <h4>Exactitud (Accuracy)</h4>
                </div>
                <div class="card-body d-flex flex-column justify-content-center">
                    <h2 class="display-4 fw-bold">{{ accuracy }}</h2>
                </div>
            </div>
        </div>
        <div class="col-lg-8 mb-4">
            <div class="card h-100 shadow-sm">
                <div class="card-header">
                    <h4>Matriz de Confusión</h4>
                </div>
                <div class="card-body text-center">
                    <img src="{{ url_for('static', filename=matriz_url) }}" class="img-fluid rounded"
                        alt="Matriz de Confusión">
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h4>Reporte de Clasificación Detallado</h4>
                </div>
                <div class="card-body">
                    <table class="table table-hover text-center">
                        <thead class="table-dark">
                            <tr>
                                <th>Clase</th>
                                <th>Precisión</th>
                                <th>Recall (Sensibilidad)</th>
                                <th>F1-Score</th>
                                <th>Support (Muestras)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for class, metrics in reporte.items() %}
                            {% if class in ['Aprobado', 'Rechazado'] %}
                            <tr>
                                <td><strong>{{ class }}</strong></td>
                                <td>{{ "%.2f"|format(metrics.precision) }}</td>
                                <td>{{ "%.2f"|format(metrics.recall) }}</td>
                                <td>{{ "%.2f"|format(metrics['f1-score']) }}</td>
                                <td>{{ metrics.support }}</td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}